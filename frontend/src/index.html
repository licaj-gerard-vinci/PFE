<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Frontend</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
</head>
<body class="mat-typography">
  <div id="navbar" class="navbar">
    <div id="navbar-left" class="navbar-left"></div>
    <div id="navbar-right" class="navbar-right"></div>
  </div>
  <app-root></app-root>

  <script> //Je n'ai pas eu de choix que de mettre le script ici car je n'ai pas pu le mettre dans un fichier séparé
           //j'ai dabord creer un component pour la navbar mais je n'ai pas pu l'importer dans le fichier index.html
           // malgré un code complet cela ne voulait pas s'afficher et je n'ai eu actuellement le choix que de mettre ce scripte
           //^_^'

    function initializeFromSessionStorage() {
      const token = sessionStorage.getItem('token');
      if (!token) {
        console.error('Token not found in sessionStorage');
        return null;
      }
      return token;
    }

    // Fonction pour décoder le token JWT
    function decodeToken(token) {
      try {
        const decodedToken = jwt_decode(token);
        return decodedToken;
      } catch (error) {
        console.error('Error decoding token:', error);
        return null;
      }
    }

    function isAdmin() {
      const token = initializeFromSessionStorage();
      if (!token) return false;

      const decodedToken = decodeToken(token);
      if (!decodedToken) return false;

      const email = decodedToken.email || decodedToken.user_id || '';
      const isAdmin = email.includes('@admin') || email.includes('@betterbusiness');
      return isAdmin;
    }

    function updateUIBasedOnRole() {
      const navbarRight = document.getElementById('navbar-right');
      if (!navbarRight) {
        console.error('Navbar-right element not found');
        return;
      }

      if (isAdmin()) {
        let dashboardButton = document.createElement('a');
        dashboardButton.id = 'dashboard-button';
        dashboardButton.textContent = 'Dashboard';
        dashboardButton.href = '/dashboard';
        dashboardButton.style.padding = '10px 20px';
        dashboardButton.style.fontSize = '16px';
        dashboardButton.style.cursor = 'pointer';
        dashboardButton.style.marginLeft = '10px';
        navbarRight.appendChild(dashboardButton);
      } else {
        let engagementButton = document.createElement('a');
        engagementButton.id = 'engagement-button';
        engagementButton.textContent = 'rapport';
        engagementButton.href = '/rapport';
        engagementButton.style.padding = '10px 20px';
        engagementButton.style.fontSize = '16px';
        engagementButton.style.cursor = 'pointer';
        engagementButton.style.marginLeft = '10px';
        navbarRight.appendChild(engagementButton);
      }
    }



    function updateLoginButtons() {
      const isLoggedIn = !!initializeFromSessionStorage(); // Est connecté si le token existe
      const navbarRight = document.getElementById('navbar-right');
      if (!navbarRight) {
        console.error('Navbar-right element not found');
        return;
      }

      if (!isLoggedIn) {
        let loginButton = document.getElementById('login-button');
        if (!loginButton) {
          loginButton = document.createElement('a');
          loginButton.id = 'login-button';
          loginButton.textContent = 'Se connecter';
          loginButton.href = '/login';
          loginButton.style.padding = '10px 20px';
          loginButton.style.fontSize = '16px';
          loginButton.style.cursor = 'pointer';
          loginButton.style.marginLeft = '10px';
          navbarRight.appendChild(loginButton);
        }
        loginButton.style.display = 'block';

        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) logoutButton.style.display = 'none';
      } else {
        let logoutButton = document.getElementById('logout-button');
        if (!logoutButton) {
          logoutButton = document.createElement('a');
          logoutButton.id = 'logout-button';
          logoutButton.textContent = 'Se déconnecter';
          logoutButton.href = '/logout';
          logoutButton.onclick = () => {
            sessionStorage.removeItem('token');
            window.location.reload();
          };
          logoutButton.style.padding = '10px 20px';
          logoutButton.style.fontSize = '16px';
          logoutButton.style.cursor = 'pointer';
          logoutButton.style.marginLeft = '10px';
          navbarRight.appendChild(logoutButton);
        }
        logoutButton.style.display = 'block';

        const loginButton = document.getElementById('login-button');
        if (loginButton) loginButton.style.display = 'none';
      }
    }


    document.addEventListener('DOMContentLoaded', () => {
      const token = initializeFromSessionStorage();
      if (token) {
        updateUIBasedOnRole();
      } else {
        console.error('No token found, cannot update UI');
      }
      updateLoginButtons();
    });
  </script>
</body>
</html>
